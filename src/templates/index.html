<!DOCTYPE html>
<html lang='fr'>
<head>
    <meta charset='UTF-8'>
    <title>Métronome Web Flask</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 30px; }
        .bpm-multi-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 40px;
            margin-bottom: 30px;
        }
        .bpm-col {
            position: relative;
            width: 80px;
            height: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .bpm-input {
            margin-bottom: 5px;
            width: 60px;
            text-align: center;
            font-size: 15px;
        }
        .bpm-scale {
            position: relative;
            width: 60px;
            height: 400px;
            border-left: 2px solid #888;
            background: linear-gradient(to top, #f8f8f8 0%, #e0e0e0 100%);
        }
        .bpm-tick {
            position: absolute;
            left: 0;
            width: 20px;
            height: 1px;
            background: #888;
        }
        .bpm-label {
            position: absolute;
            left: 25px;
            font-size: 12px;
            color: #444;
            transform: translateY(50%);
        }
        .slider-dot {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            z-index: 2;
        }
        .slider-dot .slider-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #3498db;
            border: 3px solid #2980b9;
            margin-right: 10px;
            transition: border 0.2s, background 0.2s;
        }
        .slider-dot.active .slider-circle {
            background: #e74c3c;
            border: 3px solid #c0392b;
        }
        .slider-dot .slider-bpm-label {
            font-weight: bold;
            font-size: 15px;
            color: #222;
            min-width: 40px;
            text-align: left;
            margin-left: 10px;
        }
        .bpm-slider {
            margin-top: 10px;
            width: 60px;
        }
        .intermediate-dot {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            z-index: 1;
        }
        .intermediate-dot .dot-circle {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #bbb;
            border: 2px solid #eee;
            margin-right: 8px;
            transition: background 0.2s, border 0.2s;
        }
        .intermediate-dot.active .dot-circle {
            background: #e74c3c;
            border: 2px solid #c0392b;
        }
        .intermediate-dot .dot-bpm-label {
            font-size: 13px;
            color: #444;
            min-width: 30px;
            text-align: left;
        }
        .final-dots-row {
            position: absolute;
            left: 100px;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 10px;
        }
        .final-dot {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .final-dot .dot-circle {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #bbb;
            border: 2px solid #eee;
            margin-bottom: 2px;
            transition: background 0.2s, border 0.2s;
        }
        .final-dot.active .dot-circle {
            background: #e74c3c;
            border: 2px solid #c0392b;
        }
        .final-dot .dot-bpm-label {
            font-size: 13px;
            color: #444;
            min-width: 30px;
            text-align: center;
        }
        .dot { font-size: 80px; color: gray; transition: color 0.1s; }
        .dot.active { color: red; }
        .controls { margin: 30px; }
        #start-stop { font-size: 1.2em; padding: 10px 30px; }
        .song-selector {
            margin: 20px auto;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            max-width: 400px;
        }
        .song-selector select {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .song-selector select:focus {
            outline: none;
            border-color: #3498db;
        }
        .manage-songs-btn {
            display: inline-block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .manage-songs-btn:hover {
            background-color: #2980b9;
        }
        .nav-buttons {
            margin: 20px auto;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .nav-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .nav-btn:hover {
            background-color: #2980b9;
        }
        .current-bpm {
            font-size: 48px;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 20px;
            text-align: center;
        }
        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
            margin-top: 10px;
        }
        .columns {
            display: flex;
            gap: 40px;
            justify-content: center;
        }
        .song-column {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px 12px;
            min-width: 320px;
            box-shadow: 0 2px 8px #0001;
        }
        .column-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 18px;
            text-align: center;
            color: #1976d2;
        }
        .song-list {
            min-height: 60px;
        }
        .song-item {
            background: #fff;
            padding: 14px 12px;
            margin: 10px 0;
            border-radius: 6px;
            box-shadow: 0 1px 4px #0001;
            cursor: move;
        }
        .song-item.dragging {
            opacity: 0.5;
            background: #e3f0ff;
        }
        .song-info { flex: 1; display: flex; flex-direction: column; }
        .song-title { font-weight: bold; color: #2c3e50; font-size: 16px; }
        .song-bpm { color: #7f8c8d; margin-left: 8px; font-size: 14px; }
        .song-speeds { color: #444; font-size: 13px; }
        .apply-btn {
            display: block;
            margin: 0 auto 24px auto;
            padding: 12px 32px;
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .apply-btn:hover {
            background: #1256a3;
        }
        /* --- Formulaire joli --- */
        .add-song-form {
            background: #f8f9fa;
            padding: 28px 32px 22px 32px;
            border-radius: 10px;
            margin: 30px auto 30px auto;
            max-width: 420px;
            box-shadow: 0 2px 12px #0001;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .add-song-form h2 {
            font-size: 1.4em;
            color: #1976d2;
            margin-bottom: 10px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            color: #2c3e50;
            font-weight: 500;
        }
        .form-group input {
            padding: 10px 12px;
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            font-size: 16px;
            background: #fff;
            transition: border 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #1976d2;
            background: #e3f0ff;
        }
        .submit-btn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 12px 0;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .submit-btn:hover {
            background: #1256a3;
        }
    </style>
</head>
<body>
    <h1>🕒 Métronome Web Flask</h1>
    
    <!-- Boutons de navigation -->
    <div class="nav-buttons">
        <a href="/manage-songs" class="nav-btn">Gérer les chansons</a>
        <a href="/guitar-goals" class="nav-btn">Objectifs Guitare</a>
        <a href="/manage-songsterr-links" class="nav-btn">Liens Songsterr</a>
    </div>
    
    <!-- Menu déroulant des chansons -->
    <div class="song-selector">
        <select id="song-select">
            <option value="">Sélectionner une chanson...</option>
            {% for song in songs %}
            <option value="{{ song.bpm }}"
                    data-song-id="{{ song.id }}"
                    data-title="{{ song.title }}"
                    data-min-speed="{{ song.min_speed }}"
                    data-max-speed="{{ song.max_speed }}"
                    data-challenge-speed="{{ song.challenge_speed }}"
                    data-inter-measures="{{ song.intermediate_measures }}">
                {{ song.title }} ({{ song.bpm }} BPM)
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Informations de la chanson sélectionnée -->
    <div id="song-info" style="display: none; margin: 20px auto; max-width: 400px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <div style="margin-bottom: 10px;">
            <strong>Titre :</strong> <span id="selected-title"></span>
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Song BPM:</strong> <span id="selected-bpm"></span>
        </div>
        <div style="display: flex; justify-content: space-between; gap: 10px;">
            <div><strong>Min Speed:</strong> <span id="min-speed"></span></div>
            <div><strong>Max Speed:</strong> <span id="max-speed"></span></div>
            <div><strong>Challenge Speed:</strong> <span id="challenge-speed"></span></div>
        </div>
        <div style="margin-top: 10px;">
            <strong>Mesures intermédiaires :</strong> <span id="inter-measures-display"></span>
        </div>
    </div>

    <div class="bpm-multi-container">
        <div class="bpm-col" id="col1">
            <input class="bpm-input" id="bpm-input-1" type="number" min="40" max="240" value="100" step="5" />
            <div class="bpm-scale" id="bpm-scale-1"></div>
            <div id="slider-dot-1"></div>
        </div>
        <div class="bpm-col" id="col2">
            <div id="intermediate-dots-1"></div>
        </div>
        <div class="bpm-col" id="col3">
            <input class="bpm-input" id="bpm-input-2" type="number" min="40" max="240" value="120" step="5" />
            <div class="bpm-scale" id="bpm-scale-2"></div>
            <div id="slider-dot-2"></div>
        </div>
        <div class="bpm-col" id="col4">
            <div id="intermediate-dots-2"></div>
        </div>
        <div class="bpm-col" id="col5">
            <input class="bpm-input" id="bpm-input-3" type="number" min="40" max="240" value="140" step="5" />
            <div class="bpm-scale" id="bpm-scale-3"></div>
            <div id="slider-dot-3"></div>
            <div style="position: relative; width: 100%; height: 400px;">
                <div id="final-dots" class="final-dots-row"></div>
            </div>
        </div>
    </div>
    <div>
        <label for="beats">Temps par mesure : </label>
        <input type="number" id="beats" min="1" max="12" value="4" style="width: 50px;" />
        &nbsp;&nbsp;
        <label for="interMeasures">Mesures par point intermédiaire : </label>
        <input type="number" id="interMeasures" min="1" max="8" value="1" style="width: 50px;" />
    </div>
    <div class="controls">
        <button id="start-stop">Start</button>
        <button id="full-workout">Full Workout</button>
        <button id="stop-btn" disabled>Arrêter</button>
        <button id="update-speeds" style="margin-left: 20px; background-color: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Mettre à jour les vitesses</button>
        <button id="record-btn" style="margin-left: 20px;">Start Recording</button>
    </div>
    <div id="dot" class="dot">●</div>
    <div id="current-bpm" class="current-bpm">100 BPM</div>
    <div id="countdown" class="countdown"></div>
    <audio id="click" src="/static/metronome-85688.mp3"></audio>
    <script>
        console.log('JS chargé sur /manage-songs');
        const BPM_MIN = 40;
        const BPM_MAX = 240;
        const SCALE_HEIGHT = 400;
        const NUM_POINTS_1 = 10;
        const NUM_POINTS_2 = 5;
        const NUM_FINAL_POINTS = 10;

        const prioritizedSongs = [
            {% for song in songs %}
            {
                title: "{{ song.title }}",
                bpm: {{ song.bpm }},
                min_speed: {{ song.min_speed }},
                max_speed: {{ song.max_speed }},
                challenge_speed: {{ song.challenge_speed }},
                intermediate_measures: {{ song.intermediate_measures }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        function createScale(scaleId) {
            const scale = document.getElementById(scaleId);
            scale.innerHTML = '';
            for (let bpm = BPM_MIN; bpm <= BPM_MAX; bpm += 10) {
                const y = SCALE_HEIGHT - ((bpm - BPM_MIN) / (BPM_MAX - BPM_MIN)) * SCALE_HEIGHT;
                const tick = document.createElement('div');
                tick.className = 'bpm-tick';
                tick.style.top = `${y}px`;
                tick.style.height = '1px';
                scale.appendChild(tick);
                const label = document.createElement('div');
                label.className = 'bpm-label';
                label.style.top = `${y-7}px`;
                label.textContent = bpm;
                scale.appendChild(label);
            }
        }
        createScale('bpm-scale-1');
        createScale('bpm-scale-2');
        createScale('bpm-scale-3');

        const bpmInputs = [
            document.getElementById('bpm-input-1'),
            document.getElementById('bpm-input-2'),
            document.getElementById('bpm-input-3')
        ];
        const sliderDotDivs = [
            document.getElementById('slider-dot-1'),
            document.getElementById('slider-dot-2'),
            document.getElementById('slider-dot-3')
        ];
        const intermediateDots1Div = document.getElementById('intermediate-dots-1');
        const intermediateDots2Div = document.getElementById('intermediate-dots-2');
        const finalDotsDiv = document.getElementById('final-dots');
        let sliderDots = [];
        let intermediateDots1 = [];
        let intermediateDots2 = [];
        let finalDots = [];

        function bpmToY(bpm) {
            return SCALE_HEIGHT - ((bpm - BPM_MIN) / (BPM_MAX - BPM_MIN)) * SCALE_HEIGHT;
        }

        function createSliders() {
            sliderDots = [];
            for (let i = 0; i < 3; i++) {
                sliderDotDivs[i].innerHTML = '';
                const bpm = parseInt(bpmInputs[i].value);
                const dot = document.createElement('div');
                dot.className = 'slider-dot';
                dot.style.top = `${bpmToY(bpm)}px`;
                dot.innerHTML = `
                    <div class="slider-circle"></div>
                    <span class="slider-bpm-label">${bpm}</span>
                `;
                sliderDotDivs[i].appendChild(dot);
                sliderDots.push(dot);
            }
        }
        createSliders();

        function createIntermediateDots1() {
            intermediateDots1Div.innerHTML = '';
            intermediateDots1 = [];
            const bpm1 = parseInt(bpmInputs[0].value);
            const bpm2 = parseInt(bpmInputs[1].value);
            for (let i = 1; i <= NUM_POINTS_1; i++) {
                let bpm = bpm1 + (bpm2 - bpm1) * (i / (NUM_POINTS_1 + 1));
                bpm = Math.round(bpm);
                const y = bpmToY(bpm);
                const dot = document.createElement('div');
                dot.className = 'intermediate-dot';
                dot.style.top = `${y}px`;
                dot.innerHTML = `
                    <div class="dot-circle"></div>
                    <span class="dot-bpm-label">${bpm}</span>
                `;
                intermediateDots1Div.appendChild(dot);
                intermediateDots1.push(dot);
            }
        }
        createIntermediateDots1();

        function createIntermediateDots2() {
            intermediateDots2Div.innerHTML = '';
            intermediateDots2 = [];
            const bpm2 = parseInt(bpmInputs[1].value);
            const bpm3 = parseInt(bpmInputs[2].value);
            for (let i = 1; i <= NUM_POINTS_2; i++) {
                let bpm = bpm2 + (bpm3 - bpm2) * (i / (NUM_POINTS_2 + 1));
                bpm = Math.round(bpm);
                const y = bpmToY(bpm);
                const dot = document.createElement('div');
                dot.className = 'intermediate-dot';
                dot.style.top = `${y}px`;
                dot.innerHTML = `
                    <div class="dot-circle"></div>
                    <span class="dot-bpm-label">${bpm}</span>
                `;
                intermediateDots2Div.appendChild(dot);
                intermediateDots2.push(dot);
            }
        }
        createIntermediateDots2();

        function createFinalDots() {
            finalDotsDiv.innerHTML = '';
            finalDots = [];
            const bpm3 = parseInt(bpmInputs[2].value);
            const y = bpmToY(bpm3);
            finalDotsDiv.style.position = 'absolute';
            finalDotsDiv.style.left = '100px';
            finalDotsDiv.style.top = `${y - 9}px`;
            for (let i = 0; i < NUM_FINAL_POINTS; i++) {
                const dot = document.createElement('div');
                dot.className = 'final-dot';
                dot.innerHTML = `
                    <div class="dot-circle"></div>
                    <span class="dot-bpm-label">${bpm3}</span>
                `;
                finalDotsDiv.appendChild(dot);
                finalDots.push(dot);
            }
        }
        createFinalDots();

        for (let i = 0; i < 3; i++) {
            bpmInputs[i].oninput = function() {
                let val = Math.max(BPM_MIN, Math.min(BPM_MAX, parseInt(this.value) || BPM_MIN));
                this.value = val;
                createSliders();
                createIntermediateDots1();
                createIntermediateDots2();
                createFinalDots();
            };
        }

        let isPlaying = false;
        const dot = document.getElementById('dot');
        const btn = document.getElementById('start-stop');
        const fullWorkoutBtn = document.getElementById('full-workout');
        const stopBtn = document.getElementById('stop-btn');
        const click = document.getElementById('click');
        const countdownDiv = document.getElementById('countdown');
        const beatsInput = document.getElementById('beats');
        const interMeasuresInput = document.getElementById('interMeasures');

        const recordBtn = document.getElementById('record-btn');
        let mediaRecorder;
        let recordedChunks = [];
        let currentFilename = '';

        function getTimestamp() {
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
        }

        async function startRecording(filename) {
            recordedChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus', audioBitsPerSecond: 192000 });
            currentFilename = filename;
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('file', blob, filename);
                formData.append('filename', filename);
                await fetch('/upload-recording', { method: 'POST', body: formData });
            };
            mediaRecorder.start();
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        recordBtn.onclick = async function() {
            if (recordBtn.textContent === 'Start Recording') {
                const filename = `manual_${getTimestamp()}.webm`;
                await startRecording(filename);
                recordBtn.textContent = 'Stop Recording';
            } else {
                stopRecording();
                recordBtn.textContent = 'Start Recording';
            }
        };
        
        // Variable pour contrôler l'arrêt du métronome
        let shouldStop = false;

        btn.onclick = async function() {
            if (isPlaying) return;
            isPlaying = true;
            shouldStop = false;
            btn.disabled = true;
            fullWorkoutBtn.disabled = true;
            stopBtn.disabled = false;
            btn.textContent = "En cours...";

            const selectedOption = document.getElementById('song-select').options[document.getElementById('song-select').selectedIndex];
            const title = selectedOption ? selectedOption.dataset.title || 'cycle' : 'cycle';
            const filename = `${title.replace(/\s+/g, '_')}_${getTimestamp()}.webm`;
            await startRecording(filename);

            const bpm1 = parseInt(bpmInputs[0].value);
            await playCountdown(bpm1);
            if (shouldStop) { stopRecording(); resetMetronome(); return; }
            playMetronomeSequence().then(() => {
                stopRecording();
                resetMetronome();
            });
        };

        fullWorkoutBtn.onclick = async function() {
            if (isPlaying) return;
            isPlaying = true;
            shouldStop = false;
            fullWorkoutBtn.disabled = true;
            btn.disabled = true;
            stopBtn.disabled = false;
            fullWorkoutBtn.textContent = "En cours...";

            for (let i = 0; i < prioritizedSongs.length; i++) {
                const song = prioritizedSongs[i];
                if (shouldStop) { resetMetronome(); return; }
                displaySongInfo(song);
                bpmInputs[0].value = song.min_speed;
                bpmInputs[1].value = song.max_speed;
                bpmInputs[2].value = song.challenge_speed;
                interMeasuresInput.value = song.intermediate_measures;
                createSliders();
                createIntermediateDots1();
                createIntermediateDots2();
                createFinalDots();

                const filename = `${song.title.replace(/\s+/g, '_')}_${getTimestamp()}.webm`;
                await startRecording(filename);

                await playCountdown(parseInt(song.min_speed));
                if (shouldStop) { stopRecording(); resetMetronome(); return; }
                await playMetronomeSequence();
                stopRecording();
                if (shouldStop) { resetMetronome(); return; }
                const nextSong = prioritizedSongs[i + 1];
                if (nextSong) {
                    displaySongInfo(nextSong);
                }
                await sleep(5000);
            }

            resetMetronome();
        };
        
        stopBtn.onclick = function() {
            shouldStop = true;
            stopBtn.disabled = true;
            stopBtn.textContent = "Arrêt en cours...";
            stopRecording();
        };
        
        function resetMetronome() {
            isPlaying = false;
            shouldStop = false;
            btn.disabled = false;
            fullWorkoutBtn.disabled = false;
            stopBtn.disabled = true;
            btn.textContent = "Start";
            fullWorkoutBtn.textContent = "Full Workout";
            stopBtn.textContent = "Arrêter";
            dot.classList.remove('active');
            sliderDots.forEach(d => d.classList.remove('active'));
            intermediateDots1.forEach(d => d.classList.remove('active'));
            intermediateDots2.forEach(d => d.classList.remove('active'));
            finalDots.forEach(d => d.classList.remove('active'));
            countdownDiv.textContent = '';
            displaySongInfo(null);
            stopRecording();
        }

        async function playCountdown(bpm) {
            const delay = 60000 / bpm;
            for (let i = 1; i <= 4; i++) {
                countdownDiv.textContent = i;
                dot.classList.add('active');
                click.currentTime = 0;
                click.play();
                await sleep(100);
                dot.classList.remove('active');
                await sleep(delay - 100);
            }
            countdownDiv.textContent = '';
        }

        async function playMetronomeSequence() {
            const bpm1 = parseInt(bpmInputs[0].value);
            const bpm2 = parseInt(bpmInputs[1].value);
            const bpm3 = parseInt(bpmInputs[2].value);
            const beatsPerMeasure = parseInt(beatsInput.value);
            const interMeasures = parseInt(interMeasuresInput.value);
            
            // Vérifier si on doit arrêter
            if (shouldStop) {
                return;
            }

            // BPM intermédiaires
            let intermediateBpms1 = [];
            for (let i = 1; i <= NUM_POINTS_1; i++) {
                let bpm = bpm1 + (bpm2 - bpm1) * (i / (NUM_POINTS_1 + 1));
                intermediateBpms1.push(Math.round(bpm));
            }
            let intermediateBpms2 = [];
            for (let i = 1; i <= NUM_POINTS_2; i++) {
                let bpm = bpm2 + (bpm3 - bpm2) * (i / (NUM_POINTS_2 + 1));
                intermediateBpms2.push(Math.round(bpm));
            }

            // 2 mesures à BPM1
            sliderDots[0].classList.add('active');
            await playMeasures(bpm1, beatsPerMeasure, interMeasures);
            if (shouldStop) { resetMetronome(); return; }
            sliderDots[0].classList.remove('active');

            // Mesures intermédiaires 1
            for (let i = 0; i < NUM_POINTS_1; i++) {
                if (shouldStop) { resetMetronome(); return; }
                intermediateDots1[i].classList.add('active');
                await playMeasures(intermediateBpms1[i], beatsPerMeasure, interMeasures);
                if (shouldStop) { resetMetronome(); return; }
                intermediateDots1[i].classList.remove('active');
            }

            // 2 mesures à BPM2
            sliderDots[1].classList.add('active');
            await playMeasures(bpm2, beatsPerMeasure, interMeasures);
            if (shouldStop) { resetMetronome(); return; }
            sliderDots[1].classList.remove('active');

            // Mesures intermédiaires 2
            for (let i = 0; i < NUM_POINTS_2; i++) {
                if (shouldStop) { resetMetronome(); return; }
                intermediateDots2[i].classList.add('active');
                await playMeasures(intermediateBpms2[i], beatsPerMeasure, interMeasures);
                if (shouldStop) { resetMetronome(); return; }
                intermediateDots2[i].classList.remove('active');
            }

            // 2 mesures à BPM3
            sliderDots[2].classList.add('active');
            await playMeasures(bpm3, beatsPerMeasure, interMeasures);
            if (shouldStop) { resetMetronome(); return; }
            sliderDots[2].classList.remove('active');

            // 10 mesures à BPM3 (final)
            for (let i = 0; i < NUM_FINAL_POINTS; i++) {
                if (shouldStop) { resetMetronome(); return; }
                finalDots[i].classList.add('active');
                await playMeasures(bpm3, beatsPerMeasure, interMeasures);
                if (shouldStop) { resetMetronome(); return; }
                finalDots[i].classList.remove('active');
            }
        }

        async function playMeasures(bpm, beatsPerMeasure, numMeasures) {
            const delay = 60000 / bpm;
            // Mettre à jour l'affichage du BPM actuel
            document.getElementById('current-bpm').textContent = `${bpm} BPM`;
            for (let m = 0; m < numMeasures; m++) {
                if (shouldStop) return;
                for (let b = 0; b < beatsPerMeasure; b++) {
                    if (shouldStop) return;
                    dot.classList.add('active');
                    click.currentTime = 0;
                    click.play();
                    await sleep(100);
                    dot.classList.remove('active');
                    await sleep(delay - 100);
                }
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function displaySongInfo(song) {
            const songInfo = document.getElementById('song-info');
            if (song) {
                document.getElementById('selected-title').textContent = song.title;
                document.getElementById('selected-bpm').textContent = song.bpm;
                document.getElementById('min-speed').textContent = song.min_speed;
                document.getElementById('max-speed').textContent = song.max_speed;
                document.getElementById('challenge-speed').textContent = song.challenge_speed;
                document.getElementById('inter-measures-display').textContent = song.intermediate_measures;
                songInfo.style.display = 'block';
            } else {
                songInfo.style.display = 'none';
            }
        }

        // Ajouter la gestion de l'affichage des informations de la chanson
        document.getElementById('song-select').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (this.value) {
                // Mettre à jour l'affichage des informations
                displaySongInfo({
                    title: selectedOption.dataset.title,
                    bpm: this.value,
                    min_speed: selectedOption.dataset.minSpeed,
                    max_speed: selectedOption.dataset.maxSpeed,
                    challenge_speed: selectedOption.dataset.challengeSpeed
                });

                // Mettre à jour les valeurs des sliders
                bpmInputs[0].value = selectedOption.dataset.minSpeed;
                bpmInputs[1].value = selectedOption.dataset.maxSpeed;
                bpmInputs[2].value = selectedOption.dataset.challengeSpeed;
                interMeasuresInput.value = selectedOption.dataset.interMeasures;

                // Mettre à jour l'affichage des sliders
                createSliders();
                createIntermediateDots1();
                createIntermediateDots2();
                createFinalDots();
            } else {
                displaySongInfo(null);
            }
        });

        // Ajouter la gestion du bouton de mise à jour des vitesses
        document.getElementById('update-speeds').addEventListener('click', async function() {
            const songSelect = document.getElementById('song-select');
            const selectedOption = songSelect.options[songSelect.selectedIndex];
            
            if (!selectedOption.value) {
                alert("Veuillez sélectionner une chanson d'abord");
                return;
            }

            const songId = selectedOption.dataset.songId;
            const minSpeed = bpmInputs[0].value;
            const maxSpeed = bpmInputs[1].value;
            const challengeSpeed = bpmInputs[2].value;
            const interMeasures = interMeasuresInput.value;

            try {
                const response = await fetch(`/update-song-speeds/${songId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        min_speed: minSpeed,
                        max_speed: maxSpeed,
                        challenge_speed: challengeSpeed,
                        intermediate_measures: interMeasures
                    })
                });

                if (response.ok) {
                    alert('Les vitesses ont été mises à jour avec succès !');
                    // Mettre à jour les data-attributes de l'option
                    selectedOption.dataset.minSpeed = minSpeed;
                    selectedOption.dataset.maxSpeed = maxSpeed;
                    selectedOption.dataset.challengeSpeed = challengeSpeed;
                    selectedOption.dataset.interMeasures = interMeasures;
                } else {
                    alert('Erreur lors de la mise à jour des vitesses');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la mise à jour des vitesses');
            }
        });

        function confirmDelete(songId, songTitle) {
            document.getElementById('songTitle').textContent = songTitle;
            document.getElementById('confirmDialog').style.display = 'block';
            document.getElementById('confirmDialogBackdrop').style.display = 'block';
            document.getElementById('confirmDeleteBtn').onclick = function() {
                window.location.href = `/delete-song/${songId}`;
            };
        }

        function hideConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'none';
            document.getElementById('confirmDialogBackdrop').style.display = 'none';
        }

        // Ajout gestion case à cocher prioritaire
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.prioritaire-checkbox').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    const songId = this.getAttribute('data-song-id');
                    const prioritaire = this.checked ? 1 : 0;
                    fetch(`/update-song-prioritaire/${songId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prioritaire })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Réponse serveur:', data);
                        if (data.message) {
                            alert('Succès : ' + data.message);
                        } else if (data.error) {
                            alert('Erreur : ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Erreur réseau : ' + error);
                    });
                });
            });
        });

        document.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('song-item')) {
                console.log('Drag start sur', e.target);
                draggedItem = e.target;
                e.target.classList.add('dragging');
            }
        });

    </script>
</body>
</html>
